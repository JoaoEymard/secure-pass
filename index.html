<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Segure Pass</title>

  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="styles/style.css">
</head>

<body>
  <main>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-5">
      <div class="container">
        <span class="navbar-brand mb-0">SegurePass</span>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu-principal"
          aria-controls="menu-principal" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="menu-principal">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#mdl-secret-details">Novo</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#mdl-config">Configurações</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/JoaoEymard/segure-pass">Github</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <section class="container mb-5">

      <div id="list-secrets" class="accordion">

        <div class="accordion-item" v-for="(s, ind) in secrets">
          <h2 v-bind:id="'secret-title' + ind" class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              v-bind:data-bs-target="'#secret-details' + ind" aria-expanded="true">
              {{ s.title }}
            </button>
          </h2>
          <div v-bind:id="'secret-details' + ind" class="accordion-collapse collapse" data-bs-parent="#list-secrets">
            <div class="accordion-body">

              <div class="row g-3 pt-2 pb-3">
                <div class="col-md-6">
                  <span>Link:</span>
                  <input type="text" class="form-control form-control-sm" v-bind:value="s.link" readonly>
                </div>
                <div class="col-md-6">
                  <span>Tags:</span>
                  <input type="text" class="form-control form-control-sm" v-bind:value="s.tags" readonly>
                </div>
                <div class="col-12">
                  <span>Segredo:</span>
                  <textarea rows="4" class="form-control form-control-sm" v-bind:value="s.content || s.secret"
                    readonly></textarea>
                </div>
              </div>

              <div class="d-flex flex-row-reverse">
                <button type="button" class="btn btn-sm btn-primary px-3" v-on:click="show_secret(s)">{{
                    s.content ? 'Ocutar Segredo' : 'Mostrar Segredo'
                  }}</button>
                <button type="button" class="btn btn-sm btn-light mx-2" v-on:click="edit_secret(s)">Editar</button>
              </div>

            </div>
          </div>
        </div>

      </div>

    </section>

    <div id="mdl-secret-details" class="modal" tabindex="-1">
      <form class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detalhes do segredo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-3">

            <div class="row g-3">
              <div class="col-12">
                <span>Título:</span>
                <input name="title" type="text" class="form-control form-control-sm" maxlength="64"
                  v-bind:value="secret.title">
              </div>
              <div class="col-6">
                <span>Link/Host:</span>
                <input name="link" type="text" class="form-control form-control-sm" v-bind:value="secret.link">
              </div>
              <div class="col-6">
                <span>Tags:</span>
                <input name="tags" type="text" class="form-control form-control-sm" v-bind:value="secret.tags">
              </div>
              <div class="col-12">
                <span>Segredo:</span>
                <textarea name="secret" class="form-control form-control-sm" rows="4"
                  v-bind:value="secret.content"></textarea>
              </div>

              <div class="col-6" v-if="secret.created_at">
                <span>Criado em:</span>
                <input type="text" class="form-control form-control-sm"
                  v-bind:value="new Date(secret.created_at).toLocaleString()" readonly>
              </div>
              <div class="col-6" v-if="secret.updated_at">
                <span>Atualizado em:</span>
                <input type="text" class="form-control form-control-sm"
                  v-bind:value="new Date(secret.updated_at).toLocaleString()" readonly>
              </div>
            </div>

          </div>
          <div class="modal-footer border-0 flex-row-reverse">
            <button type="submit" class="btn btn-sm btn-primary px-3">Salvar</button>
          </div>
        </div>
      </form>
    </div>

    <div id="mdl-config" class="modal" tabindex="-1">
      <form class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Configurações</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-3">

            <div class="row g-3">
              <div class="col-12">
                <span>Importar dados:</span>
                <input type="file" class="form-control form-control-sm">
              </div>

              <div class="col-12">
                <div class="text-center" style="z-index: 99;">
                  <span class="bg-white px-3">ou</span>
                </div>
                <hr style="margin-top: -12px; opacity: 1; background-color: #c8c9ca;">
              </div>

              <div class="col-12">
                <span>Hash criptográfico:</span>
                <div class="input-group mb-3">
                  <input name="hash" type="text" class="form-control form-control-sm" maxlength="256"
                    v-bind:value="config.hash || ''">
                  <button class="btn btn-sm btn-outline-secondary" type="button" v-on:click="gerarHash">Gerar
                    aleatório</button>
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer border-0 flex-row-reverse">
            <button type="submit" class="btn btn-sm btn-primary px-3">Salvar</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportData()">Exportar
              dados</button>
            <button type="button" class="btn btn-sm btn-danger me-auto" onclick="storageSecrets.clear()">Limpar
              lista</button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/export-from-json.min.js"></script>
  <script src="assets/crypto-js.min.js"></script>
  <script src="assets/vue.min.js"></script>
  <script src="assets/storage.js"></script>
  <script src="scripts/main.js"></script>

  <script>
    const v = new Vue({
      el: 'main',
      data: {
        secrets: [],
        secret: {},
        config: {},
      },
      methods: {
        save_secret: async function () {
          const secret = {
            ...this.secret,
            ...serialize.formSecretDetails(),
          };
          delete secret.content;

          if (secret.id) {
            storageSecrets.map((s) => s.id === secret.id ? {
              ...secret,
              updated_at: Date.now(),
            } : s);
          } else {
            storageSecrets.push({
              ...secret,
              id: uuid(),
              created_at: Date.now(),
              updated_at: Date.now(),
            });
          }

          bsMdlSecretDetails.hide();
        },
        edit_secret: function (secret) {
          this.secret = {
            ...secret,
            content: decrypted(secret.secret)
          };

          bsMdlSecretDetails.show();
        },
        show_secret: async function (secret) {
          if (secret.content) {
            delete secret.content;
          } else {
            secret.content = decrypted(secret.secret)
          }

          this.$forceUpdate();
        },
        gerarHash: function () {
          this.config.hash = randPassword(128);

          this.$forceUpdate();
        }
      }
    });

    const $formSecretDetails = document.querySelector('#mdl-secret-details form');
    const bsMdlSecretDetails = new bootstrap.Modal($formSecretDetails.parentElement);
    const $formConfig = document.querySelector('#mdl-config form');
    const bsMdlConfig = new bootstrap.Modal($formConfig.parentElement);

    $formSecretDetails.addEventListener('submit', async function (el) {
      el.preventDefault();

      await v.save_secret();
      el.target.reset();

      bsMdlSecretDetails.hide();
    })
    $formConfig.addEventListener('submit', async function (el) {
      el.preventDefault();

      storageConfig.data = v.config = serialize.formConfig();
      el.target.reset();

      bsMdlConfig.hide();
    })

    $formConfig.parentElement.addEventListener('shown.bs.modal', function (ev) {
      ev.target.querySelector('input').focus();
    })
    $formConfig.querySelector('input[type=file]').addEventListener('change', async function (ev) {
      const { data, ...config } = JSON.parse(
        await getFileReader(ev.target.files[0])
      );

      v.config = storageConfig.data = config;
      storageSecrets.data = JSON.parse(decrypted(data));

      bsMdlConfig.hide();
    })
    $formSecretDetails.parentElement.addEventListener('shown.bs.modal', function (ev) {
      ev.target.querySelector('input').focus();
    })
    $formSecretDetails.parentElement.addEventListener('hidden.bs.modal', function () {
      v.secret = {}
    })

    window.onload = async () => {
      if (!Array.isArray(storageSecrets.filter())) {
        storageSecrets.data = [];
      }

      if (!storageConfig.find() || !storageConfig.find().hash) {
        bsMdlConfig.show();
      }

      v.secrets = storageSecrets.filter();
      v.config = storageConfig.find() || {};
    }
  </script>
</body>

</html>